// Prisma Schema for Amis Language Learning Platform (PostgreSQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CardStatus {
  NEW
  LEARNING
  REVIEWED
}

enum ReviewMode {
  CHOICE
  SPELL
  MIXED
}

enum ReviewSessionType {
  NORMAL
  POST_TEST
}

model User {
  id          String          @id @default(cuid())
  email       String          @unique
  name        String?
  createdAt   DateTime        @default(now())
  preferences UserPreference?
  stats       UserCardStat[]
  reviews     Review[]
  sessions    ReviewSession[]

  @@map("users")
}

model UserPreference {
  id               String   @id @default(cuid())
  userId           String   @unique @map("user_id")
  user             User     @relation(fields: [userId], references: [id])
  dailyNewTarget   Int      @default(10) // 1-50
  reviewRatio      Int      @default(50) // 10-80
  dialectFilter    String[] // array of dialect codes or ids
  spellingTolerance Int     @default(85) // 70-100

  @@map("user_preferences")
}

model Dialect {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  region    String?
  createdAt DateTime @default(now())
  flashcards Flashcard[]
  sentences  Sentence[]

  @@map("dialects")
}

model Flashcard {
  id         String     @id @default(cuid())
  dialectId  String     @map("dialect_id")
  dialect    Dialect    @relation(fields: [dialectId], references: [id])
  lemma      String
  phonetic   String?
  meaning    String?
  status     CardStatus @default(NEW)
  tags       String[]
  createdBy  String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  stats      UserCardStat[]
  reviews    Review[]
  links      SentenceWordLink[]

  @@index([lemma])
  @@index([dialectId, status])
  @@map("flashcards")
}

model Sentence {
  id         String   @id @default(cuid())
  dialectId  String   @map("dialect_id")
  dialect    Dialect  @relation(fields: [dialectId], references: [id])
  text       String
  translation String?
  createdBy  String?
  createdAt  DateTime @default(now())
  links      SentenceWordLink[]

  @@index([dialectId])
  @@map("sentences")
}

model SentenceWordLink {
  id          String   @id @default(cuid())
  sentenceId  String   @map("sentence_id")
  sentence    Sentence @relation(fields: [sentenceId], references: [id])
  flashcardId String   @map("flashcard_id")
  flashcard   Flashcard @relation(fields: [flashcardId], references: [id])
  startIndex  Int      @map("start_index")
  endIndex    Int      @map("end_index")

  @@unique([sentenceId, flashcardId, startIndex, endIndex])
  @@map("sentence_word_links")
}

model UserCardStat {
  id             String     @id @default(cuid())
  userId         String     @map("user_id")
  user           User       @relation(fields: [userId], references: [id])
  flashcardId    String     @map("flashcard_id")
  flashcard      Flashcard  @relation(fields: [flashcardId], references: [id])
  ef             Float      @default(2.5) // SM-2 EF
  intervalDays   Int        @default(0)  @map("interval_days")
  repetitions    Int        @default(0)
  nextReviewAt   DateTime?  @map("next_review_at")
  lastReviewAt   DateTime?  @map("last_review_at")
  currentPriority Int       @default(4)  @map("current_priority")
  status         CardStatus @default(NEW)
  wrongCount     Int        @default(0)  @map("wrong_count")

  @@index([userId, currentPriority])
  @@index([nextReviewAt])
  @@unique([userId, flashcardId])
  @@map("user_card_stats")
}

model ReviewSession {
  id        String            @id @default(cuid())
  userId    String            @map("user_id")
  user      User              @relation(fields: [userId], references: [id])
  type      ReviewSessionType @default(NORMAL)
  createdAt DateTime          @default(now())
  reviews   Review[]

  @@map("review_session")
}

model Review {
  id           String       @id @default(cuid())
  userId       String       @map("user_id")
  user         User         @relation(fields: [userId], references: [id])
  flashcardId  String       @map("flashcard_id")
  flashcard    Flashcard    @relation(fields: [flashcardId], references: [id])
  sessionId    String?      @map("session_id")
  session      ReviewSession? @relation(fields: [sessionId], references: [id])
  mode         ReviewMode
  score        Int          // 1-4 per spec
  similarity   Float?       // for SPELL mode (0-100)
  quality      Int?         // mapped SM-2 quality (e.g., 2-5)
  createdAt    DateTime     @default(now()) @map("created_at")

  @@index([userId, flashcardId])
  @@map("reviews")
}
